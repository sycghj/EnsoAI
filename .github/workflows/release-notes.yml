name: Release Notes

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag name to update (e.g. v0.1.6)'
        required: true

permissions:
  contents: write
  id-token: write

jobs:
  update-release-notes:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set Tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG="${{ github.event.inputs.tag }}"
          else
            TAG="${{ github.event.release.tag_name }}"
          fi
          echo "name=$TAG" >> $GITHUB_OUTPUT
          # å»æ‰ v å‰ç¼€ä½œä¸ºç‰ˆæœ¬å·
          VERSION="${TAG#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Get Previous Tag
        id: prev_tag
        run: |
          CURRENT_TAG="${{ steps.tag.outputs.name }}"
          PREV_TAG=$(git tag --sort=-version:refname | grep -A1 "^${CURRENT_TAG}$" | tail -1)
          if [ "$PREV_TAG" = "$CURRENT_TAG" ] || [ -z "$PREV_TAG" ]; then
            PREV_TAG=$(git rev-list --max-parents=0 HEAD)
          fi
          echo "prev_tag=$PREV_TAG" >> $GITHUB_OUTPUT

      - name: Get Commits
        id: commits
        run: |
          COMMITS=$(git log ${{ steps.prev_tag.outputs.prev_tag }}..${{ steps.tag.outputs.name }} --pretty=format:"- %s (%h)" --no-merges | head -50)
          echo "commits<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate Release Notes
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.ANTHROPIC_AUTH_TOKEN }}
          settings: |
            {
              "env": {
                "ANTHROPIC_BASE_URL": "${{ secrets.ANTHROPIC_BASE_URL }}",
                "ANTHROPIC_AUTH_TOKEN": "${{ secrets.ANTHROPIC_AUTH_TOKEN }}",
                "CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC": "1"
              }
            }
          prompt: |
            è¯·æ ¹æ®ä»¥ä¸‹ commits ç”Ÿæˆä¸­æ–‡ç‰ˆ GitHub Release Notesï¼Œå¹¶å†™å…¥ /tmp/release-notes.md æ–‡ä»¶ã€‚

            **ç‰ˆæœ¬**: ${{ steps.tag.outputs.name }}
            **ç‰ˆæœ¬å·ï¼ˆæ— vå‰ç¼€ï¼‰**: ${{ steps.tag.outputs.version }}
            **ä¸Šä¸€ç‰ˆæœ¬**: ${{ steps.prev_tag.outputs.prev_tag }}
            **ä»“åº“**: ${{ github.repository }}

            **Commits**:
            ```
            ${{ steps.commits.outputs.commits }}
            ```

            **è¦æ±‚**:
            1. å°†è‹±æ–‡ commit message ç¿»è¯‘ä¸ºç®€æ´çš„ä¸­æ–‡æè¿°
            2. æŒ‰ç±»å‹åˆ†ç±»ï¼š
               - feat â†’ âœ¨ æ–°åŠŸèƒ½
               - fix â†’ ğŸ› é—®é¢˜ä¿®å¤
               - ci/build â†’ ğŸ”¨ CI/CD
               - chore â†’ ğŸ§¹ å…¶ä»–ï¼ˆè·³è¿‡ release commitï¼‰
            3. åªä¿ç•™æœ‰å†…å®¹çš„åˆ†ç±»
            4. ä½¿ç”¨ Write å·¥å…·å°†å®Œæ•´å†…å®¹å†™å…¥ ${{ github.workspace }}/release-notes.md

            **è¾“å‡ºæ ¼å¼**ï¼ˆç›´æ¥å†™å…¥æ–‡ä»¶ï¼Œä¸è¦è¾“å‡ºåˆ°ç»ˆç«¯ï¼‰:
            ```markdown
            ## æ›´æ–°å†…å®¹

            ### âœ¨ æ–°åŠŸèƒ½
            - **ä¸­æ–‡åŠŸèƒ½æè¿°**

            ### ğŸ› é—®é¢˜ä¿®å¤
            - **ä¸­æ–‡ä¿®å¤æè¿°**

            ---

            ## ğŸ“¦ ä¸‹è½½

            | å¹³å° | æ–‡ä»¶ |
            |------|------|
            | macOS (Apple Silicon) | [EnsoAI-{VERSION}-arm64.dmg](https://github.com/{REPO}/releases/download/{TAG}/EnsoAI-{VERSION}-arm64.dmg) |
            | macOS (Intel) | [EnsoAI-{VERSION}.dmg](https://github.com/{REPO}/releases/download/{TAG}/EnsoAI-{VERSION}.dmg) |
            | Windows (x64 å®‰è£…ç‰ˆ) | [EnsoAI-Setup-{VERSION}.exe](https://github.com/{REPO}/releases/download/{TAG}/EnsoAI-Setup-{VERSION}.exe) |

            > âš ï¸ **macOS ç”¨æˆ·æ³¨æ„**: ç”±äºåº”ç”¨æœªç­¾åï¼Œé¦–æ¬¡æ‰“å¼€å¯èƒ½æç¤º"å·²æŸå"ï¼Œè¯·åœ¨ç»ˆç«¯æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š
            > ```bash
            > sudo xattr -dr com.apple.quarantine /Applications/EnsoAI.app
            > ```

            ---

            **Full Changelog**: https://github.com/{REPO}/compare/{PREV_TAG}...{TAG}
            ```

            è¯·ç”¨å®é™…å€¼æ›¿æ¢ {VERSION}ã€{TAG}ã€{REPO}ã€{PREV_TAG}ï¼Œç„¶åä½¿ç”¨ Write å·¥å…·å†™å…¥ ${{ github.workspace }}/release-notes.md æ–‡ä»¶ã€‚

      - name: Update Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release edit ${{ steps.tag.outputs.name }} --notes-file ${{ github.workspace }}/release-notes.md
